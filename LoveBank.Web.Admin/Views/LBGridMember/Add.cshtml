@using LoveBank.MVC

@Html.IncludeCSS("~/Content/plug-in/webuploader/webuploader.css")
@Html.IncludeScript("~/Content/plug-in/webuploader/webuploader.js")
@Html.IncludeCSS("~/Content/Css/demo.css")
@Html.IncludeCSS("~/Content/plug-in/webuploader/demo.css")


@*<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" />

<!-- 最新 Bootstrap 核心 CSS 文件 -->
<link rel="stylesheet" href="http://cdn.bootcss.com/twitter-bootstrap/3.0.3/css/bootstrap.min.css" />

<!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
<script src="http://cdn.bootcss.com/twitter-bootstrap/3.0.3/js/bootstrap.min.js"> </script>*@


<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
<script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<link href="http://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

<link rel="stylesheet" href="http://cdn.bootcss.com/summernote/0.5.1/summernote.css" />
<script src="http://cdn.bootcss.com/summernote/0.5.1/summernote.min.js"></script>

<style>
    .panel-tool {
        right: initial;
        margin-left: 100px;
    }

    #uploader .placeholder {
        padding-top: 0px;
    }

    .queueList {
        width: 300px;
    }

    #uploader .queueList.filled {
        padding: 0px;
    }
</style>

@*@Html.IncludeCSS("~/Content/plug-in/summernote/summernote.css")
@Html.IncludeScript("~/Content/plug-in/summernote/summernote.js")*@


<script type="text/javascript">

</script>
<style>
    *, *:before, *:after {
        -webkit-box-sizing: inherit;
        box-sizing: inherit;
    }
</style>




<div id="p" class="easyui-panel" title="新增网格员" data-options="tools:'#tt'">
    @using (Html.BeginForm("PostAdd", "LBGridMember", FormMethod.Post, new { name = "AddForm", id = "AddForm" }))
    {
        <table class="form">

            <tr>
                <td class="item_title">
                    头像:
                </td>
                <td class="item_input">
                    <div id="uploader" class="wu-example" style="width:700px;margin-left:0px;">
                        <div class="queueList" style=" margin:0px; ">
                            <div id="dndArea" class="placeholder">
                                <div id="filePicker"></div>
                                <p>或将文件拖到这里,只能上传1个图片</p>
                            </div>
                        </div>
                        <div class="statusBar" style="display:none;">
                            <div class="progress">
                                <span class="text">0%</span>
                                <span class="percentage"></span>
                            </div><div class="info"></div>
                            <div class="btns">
                                <div id="filePicker2"></div><div class="uploadBtn">开始上传</div>
                            </div>
                        </div>
                    </div>

                </td>
            </tr>
            @*<tr>
                <td class="item_title">
                    服务小区:
                </td>
                <td class="item_input">
                    <input type="hidden" name="DeptId" id="DeptId" />
                    <input type="text" class="easyui-validatebox" data-options="prompt:'必填.',required:true" style="height:25px; width:260px;   " id="CoverCommunity" name="CoverCommunity"  />(必填)
                    <div id="menuContent" class="menuContent" style="display:none; z-index:10000;width:260px;  position: absolute;">
                        <ul id="ztree" class="ztree" style="margin-top:0; background-color:#edf3f7;  overflow:scroll; border:solid 1px #ccc;"></ul>
                    </div>

                </td>
            </tr>*@
            <tr>
                <td class="item_title">
                    服务小区:
                </td>
                <td class="item_input">
                    <input type="hidden" name="DeptId" id="DeptId" />
                    <input type="text" class="easyui-validatebox" data-options="prompt:'必填.',required:true" style="height:25px; width:260px;   " id="CoverCommunity" name="CoverCommunity" />(必填)
                    <div id="menuContent" class="menuContent" style="display:none; z-index:10000;width:260px;  position: absolute;">
                        <ul id="ztree" class="ztree" style="margin-top:0; background-color:#edf3f7;  overflow:scroll; border:solid 1px #ccc;"></ul>
                    </div>

                </td>
            </tr>
            <tr>
                <td class="item_title">网格号:</td>
                <td class="item_input"><input type="text" class=" easyui-validatebox" missingmessage="必须填写"
       data-options="required:true" id="GridNo" name="GridNo" /></td>
            </tr>
            <tr>
                <td class="item_title">网格员姓名:</td>
                <td class="item_input"><input type="text" class="easyui-validatebox" missingmessage="必须填写"
       data-options="required:true" id="GridName" name="GridName" /></td>
            </tr>
            <tr>
                <td class="item_title">网格员电话:</td>
                <td class="item_input"><input type="text" class="easyui-validatebox" missingmessage="必须填写"
       data-options="required:true" id="GridPhone" name="GridPhone" /></td>
            </tr>
            <tr>
                <td class="item_title">
                    描述:
                </td>
                <td class="item_input" style="float:left;">
                    @*<input class="easyui-validatebox" type="text" style="height:25px; width:260px;   " id="Desc" name="Desc"
                data-options="validType:'length[8,20]'" /> (必须填)*@
                    <textarea name="text" class="summernote" style="margin-bottom: 0px;" id="contents" required="required" title="Contents"></textarea>
                </td>
            </tr>

            <tr>
                <td class="item_title"></td>
                <td class="item_input2">
                    <!--隐藏元素-->
                    <div style="padding:5px">

                        <a href="javascript:void(0)" class="easyui-linkbutton" id="addFromSubmit"> &nbsp  &nbsp &nbsp &nbsp &nbsp 新增 &nbsp  &nbsp &nbsp &nbsp &nbsp </a>

                    </div>

                </td>
            </tr>

        </table>
    }


</div>
<div id="tt">

    <a href="@Url.Action("Index", "LBGridMember")" class="icon-back" title="返回列表"></a>
</div>

<style>
    .panel-tool {
        right: initial;
        margin-left: 100px;
    }

    .imgWrap {
        word-wrap: break-word;
        word-break: normal;
        vertical-align: bottom;
        /*margin-top:20px;*/
    }

    #uploader .placeholder {
        padding-top: 0px;
    }

    .queueList {
        width: 800px;
    }

    #uploader .queueList.filled {
        padding: 0px;
    }
</style>


@Html.IncludeScript("~/Content/JS/MachineModule/edit.js")
@Html.IncludeCSS("~/Content/plug-in/ztree/css/zTreeStyle/zTreeStyle.css")

@Html.IncludeScript("~/Content/plug-in/ztree/js/jquery.ztree.core-3.5.js")
@Html.IncludeScript("~/Content/plug-in/ztree/js/jquery.ztree.excheck-3.5.js")
@Html.IncludeScript("~/Content/plug-in/My97DatePicker/WdatePicker.js")
<script>
    @*var sourceFileListObj = eval(@Html.Raw( Json.Encode(@Model.SourceFileList)));*@
    //var sourceFileListObj = null;
    //var upLoader = $("#uploader").WebUploaderMVC({ Controllers: "/LBGridMember/", action: "/UpLoadProcess", sourceFileList: sourceFileListObj });
    ///调用文件上传
    var upLoader = $("#uploader").WebUploaderMVC({ Controllers: "/LBGridMember/", action: "/UpLoadProcess" });

    function GetFromJsonData() {
        var json = {
            "VDeptId": $("#DeptId").val(),
            "GridNo": $("#GridNo").val(),
            "GridName": $("#GridName").val(),
            "GridPhone": $("#GridPhone").val(),
            "Desc": $('.summernote').code(),
            "SourceFile": upLoader.getSourceFileList()[0]

        };
        return json;
    }


    $("#addFromSubmit").click(function () {

        if (!$("#AddForm").form('validate')) {
            return false;
        }
        var objJson = GetFromJsonData();
        if (objJson.SourceFile == null ) {
            alert("请先选择并上传至少一文件");
            return false;
        }

       
        $.ajax({
            type: "POST",
            url: "/LBGridMember/PostAdd",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(objJson),
            dataType: "json",
            success: function (data) {
                if (data.Status == true) {
                    alert("添加成功");
                    //$('#AddForm').form('clear');
                    location.reload();

                } else {
                    alert(data.Info);
                }
            },
            error: function (data) {
                alert("添加失败");
            }
        });
    });

</script>





<style>
    .imgWrap {
        word-wrap: break-word;
        word-break: normal;
        vertical-align: bottom;
        /*margin-top:20px;*/
    }
</style>
@*显示行政区域tree*@
<script type="text/javascript">
       var zNodes =@(Html.Raw(ViewData["Department_List"].ToString()));

    $("#CoverCommunity").TreeMvc({Department_List:zNodes});

    function sendFile(file, editor, $editable){
        //var $tip=  $(".note-toolbar.btn-toolbar");
        //$tip.append('正在上传图片');
        var filename = false;
        try{
            filename = file['name'];
        } catch(e){filename = false;}
        if(!filename){$(".note-alarm").remove();}
        //以上防止在图片在编辑器内拖拽引发第二次上传导致的提示错误
        var ext = filename.substr(filename.lastIndexOf("."));
        ext = ext.toUpperCase();
        var timestamp = new Date().getTime();
        var name = timestamp+"_"+$(".summernote").attr('aid')+ext;

        //name是文件名，自己随意定义，aid是我自己增加的属性用于区分文件用户
        data = new FormData();
        data.append("file", file);
        data.append("key",name);
        data.append("size","10000");
        data.append("token",$(".summernote").attr('token'));

        $.ajax({
            data: data,
            type: "POST",
            url: "/LBGridMember/UpLoadProcess",
            cache: false,
            contentType: false,
            processData: false,
            success: function(data) {
                //data是返回的hash,key之类的值，key是定义的文件名
                editor.insertImage($editable, data.Domain+data.Path);
                //url-head是自己七牛云的domain
                $(".note-alarm").html("上传成功,请等待加载");
                //$tip.html("");
                setTimeout(function(){$(".note-alarm").remove();},3000);
            },
            error:function(){
                $(".note-alarm").html("上传失败");
                setTimeout(function(){$(".note-alarm").remove();},3000);
            }
        });
    }
    $(function () {
        $('.summernote').summernote({
            height: 400,
            width: 850,
            onImageUpload:function(files, editor, $editable) {
               
                sendFile(files[0],editor,$editable);
            }
        });

       
    });
    //$(document).ready(function() {
    //    $('.summernote').summernote({
    //        height: 400,
    //        width: 800,
    //        focus:false,
    //        lang:'zh-CN',
    //        onImageUpload:function(files, editor, $editable) {
    //            alert(editor)
    //            sendFile(files[0],editor,$editable);
    //        }
    //        //方法重载
    //    });
    //});


    //然后是为了美观的css
    //.note-alarm {
    //    float: right;
    //    margin-top: 10px;
    //    margin-right: 10px;
    //}
    </script>





